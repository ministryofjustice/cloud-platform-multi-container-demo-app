apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: ecr-delete-untagged-images-cronjob
spec:
  failedJobsHistoryLimit: 1
  concurrencyPolicy: Allow
  jobTemplate:
    metadata:
      creationTimestamp: null
    spec:
      template:
        metadata:
          creationTimestamp: null
        spec:
          containers:
          - command:
            - /bin/sh
            - -c
            - |-

               UNTAGGED_IMAGES_TO_DELETE=$( aws ecr list-images --region eu-west-2 --repository-name ${myrepo} --filter "tagStatus=UNTAGGED" --query 'imageIds[*]' --output json )

               UNTAGGED_IMAGE_COUNT=$(echo $UNTAGGED_IMAGES_TO_DELETE | jq length)

               if [ ${UNTAGGED_IMAGE_COUNT} -gt 0 ]; then
                 aws ecr batch-delete-image --region eu-west-2 --repository-name ${myrepo} --image-ids "$UNTAGGED_IMAGES_TO_DELETE" || true
               else
                 echo "No untagged images to delete"
               fi
              
            env:
              - name: AWS_ACCESS_KEY_ID
                valueFrom:
                  secretKeyRef:
                    name: demosecret
                    key: access_key_id

              - name: AWS_SECRET_ACCESS_KEY
                valueFrom:
                  secretKeyRef:
                    name: demosecret
                    key: secret_access_key

              - name: AWS_DEFAULT_REGION
                value: eu-west-2

            image: 754256621582.dkr.ecr.eu-west-2.amazonaws.com/cloud-platform/tools:awscli
            imagePullPolicy: IfNotPresent
            name: aws-cli
          restartPolicy: Never  
  schedule: "0 */6 * * *"
  successfulJobsHistoryLimit: 3          
  suspend: false